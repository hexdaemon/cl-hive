# Docker Compose Override for Building from Source
#
# This file enables:
#   - Building the image locally instead of pulling pre-built
#   - Hot upgrades via host-mounted plugin directories
#
# Usage:
#   cp docker-compose.build.yml docker-compose.override.yml
#   docker-compose up -d --build
#
# Hot Upgrades (after initial build):
#   ./scripts/hot-upgrade.sh
#
# Requirements:
#   - Clone cl_revenue_ops next to cl-hive:
#       git clone https://github.com/lightning-goats/cl_revenue_ops.git ../../cl_revenue_ops
#   - Copy bitcoin-cli if not downloading in Dockerfile:
#       cp /usr/local/bin/bitcoin-cli ./bitcoin-cli

services:
  cln:
    # Build from source instead of using pre-built image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        CLN_VERSION: v25.12.1
        SLING_VERSION: v4.1.3
        CLN_REST_VERSION: v0.10.7
        CL_REVENUE_OPS_VERSION: v2.2.4
    image: cl-hive-node:local

    volumes:
      # =================================================================
      # PLUGIN MOUNTS - Enable hot upgrades via ./scripts/hot-upgrade.sh
      # These mount the git repos so updates can be pulled without rebuilding.
      # =================================================================

      # cl-hive (coordination layer)
      - ..:/opt/cl-hive:ro

      # cl-revenue-ops (execution layer)
      - ../../cl_revenue_ops:/opt/cl-revenue-ops:ro

      # bitcoin-cli mount (if not baked into image)
      - ./bitcoin-cli:/usr/local/bin/bitcoin-cli:ro
