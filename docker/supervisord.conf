[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
# Graceful shutdown: wait for all processes
shutdown_timeout=120

[program:tor]
command=/usr/bin/tor -f /etc/tor/torrc
autostart=%(ENV_TOR_ENABLED)s
autorestart=true
priority=10
# Tor stops quickly
stopwaitsecs=10
stopsignal=TERM
stdout_logfile=/var/log/supervisor/tor.log
stderr_logfile=/var/log/supervisor/tor-error.log
user=debian-tor

[program:lightningd]
command=/usr/bin/lightningd --lightning-dir=%(ENV_LIGHTNING_DIR)s --conf=%(ENV_LIGHTNING_DIR)s/config
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=3
# Graceful shutdown: allow time for HTLCs and database flush
stopwaitsecs=90
stopsignal=TERM
# Use pre-stop script for graceful shutdown
stopasgroup=true
killasgroup=true
stdout_logfile=/var/log/supervisor/lightningd.log
stderr_logfile=/var/log/supervisor/lightningd-error.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
# Wait for Tor to start if enabled
depends_on=tor

[eventlistener:lightningd_ready]
command=/bin/bash -c "sleep 30 && echo 'Lightning node ready'"
events=PROCESS_STATE_RUNNING
buffer_size=100

[eventlistener:shutdown_handler]
command=/bin/bash -c "while read line; do if echo \"$line\" | grep -q 'PROCESS_STATE_STOPPING'; then /opt/cl-hive/docker/scripts/pre-stop.sh 2>/dev/null || true; fi; done"
events=PROCESS_STATE_STOPPING
buffer_size=100

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpc_interface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock
