# cl-hive Production Node - Docker Compose
#
# Quick Start (Pre-built Image - Recommended):
#   1. cd cl-hive/docker
#   2. cp .env.example .env && nano .env  # Configure Bitcoin RPC, etc.
#   3. docker-compose up -d
#
# Quick Start (Build from Source):
#   1. Clone both repos side by side:
#        git clone https://github.com/lightning-goats/cl-hive.git
#        git clone https://github.com/lightning-goats/cl_revenue_ops.git
#   2. cd cl-hive/docker
#   3. cp .env.example .env && nano .env
#   4. cp docker-compose.build.yml docker-compose.override.yml
#   5. docker-compose up -d --build
#
# Upgrade (Pre-built Image):
#   docker-compose pull && docker-compose up -d
#
# Access lightning-cli:
#   docker-compose exec cln lightning-cli getinfo
#
# For developers wanting hot upgrades, see docker-compose.build.yml

services:
  cln:
    # Pre-built image from GitHub Container Registry (no compilation needed)
    image: ghcr.io/lightning-goats/cl-hive-node:${CL_HIVE_VERSION:-latest}
    container_name: cl-hive-node
    restart: unless-stopped

    # Graceful shutdown configuration
    stop_grace_period: 120s
    stop_signal: SIGTERM

    # Resource limits (override via docker-compose.override.yml or .env)
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-4}'
          memory: ${MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${CPU_RESERVATION:-2}'
          memory: ${MEMORY_RESERVATION:-4G}

    # Network capabilities (for Tor and optional WireGuard)
    cap_add:
      - NET_ADMIN
      - NET_RAW
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0

    # Allow container to reach host services (Linux compatibility)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    environment:
      # Bitcoin RPC (required)
      - BITCOIN_RPCHOST=${BITCOIN_RPCHOST:-host.docker.internal}
      - BITCOIN_RPCPORT=${BITCOIN_RPCPORT:-8332}
      - BITCOIN_RPCUSER=${BITCOIN_RPCUSER}
      - BITCOIN_RPCPASSWORD=${BITCOIN_RPCPASSWORD:-}

      # Network
      - NETWORK=${NETWORK:-bitcoin}

      # Node Identity
      - ALIAS=${ALIAS:-cl-hive-node}
      - RGB=${RGB:-e33502}

      # Network Mode & Connectivity
      - LIGHTNING_PORT=${LIGHTNING_PORT:-9736}
      - NETWORK_MODE=${NETWORK_MODE:-tor}
      - ANNOUNCE_ADDR=${ANNOUNCE_ADDR:-}

      # WireGuard VPN (credentials from VPN admin)
      - WIREGUARD_ENABLED=${WIREGUARD_ENABLED:-false}
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY:-}
      - WG_ADDRESS=${WG_ADDRESS:-}
      - WG_PEER_PUBLIC_KEY=${WG_PEER_PUBLIC_KEY:-}
      - WG_PEER_ENDPOINT=${WG_PEER_ENDPOINT:-}
      - WG_DNS=${WG_DNS:-}
      - WG_PEER_KEEPALIVE=${WG_PEER_KEEPALIVE:-25}

      # cl-hive
      - HIVE_GOVERNANCE_MODE=${HIVE_GOVERNANCE_MODE:-advisor}

      # CLBOSS (optional - set to false to disable)
      - CLBOSS_ENABLED=${CLBOSS_ENABLED:-true}

      # Trustedcoin (optional - alternative Bitcoin backend using block explorers)
      # When enabled without bitcoin-rpc*: explorer-only mode (no bitcoind needed)
      # When enabled with bitcoin-rpc*: hybrid mode (bitcoind primary, explorers fallback)
      - TRUSTEDCOIN_ENABLED=${TRUSTEDCOIN_ENABLED:-false}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Experimental features
      - EXPERIMENTAL_SPLICING=${EXPERIMENTAL_SPLICING:-false}

      # Channel policy (tune for new node reputation building)
      - MIN_CAPACITY_SAT=${MIN_CAPACITY_SAT:-500000}
      - FEE_BASE=${FEE_BASE:-0}
      - FEE_PER_SATOSHI=${FEE_PER_SATOSHI:-100}
      - HTLC_MINIMUM_MSAT=${HTLC_MINIMUM_MSAT:-1000}

      # Lightning directory (used by supervisord)
      - LIGHTNING_DIR=/data/lightning/${NETWORK:-bitcoin}

    volumes:
      # Persistent data
      - lightning-data:/data/lightning

      # Tor hidden service keys (persist onion address across restarts)
      - tor-data:/var/lib/tor

      # WireGuard config (optional)
      - ${WIREGUARD_CONFIG_PATH:-./wireguard}:/etc/wireguard:ro

      # Custom configs (optional)
      - ${CUSTOM_CONFIG_PATH:-./config}:/etc/lightning/custom:ro

      # Infrastructure scripts (optional overrides)
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./supervisord.conf:/etc/supervisor/conf.d/supervisord.conf:ro

      # =================================================================
      # NOTE: Plugin mounts are NOT needed when using pre-built image.
      # The image includes cl-hive and cl-revenue-ops baked in.
      #
      # For development/hot-upgrades, use docker-compose.build.yml:
      #   cp docker-compose.build.yml docker-compose.override.yml
      # =================================================================

      # bitcoin-cli mount (only needed if host has newer version)
      # - ./bitcoin-cli:/usr/local/bin/bitcoin-cli:ro

      # Backup directory for database replication and emergency.recover
      - ${BACKUP_LOCATION:-./backups}:/backups

      # Emergency.recover watcher script
      - ./scripts/emergency-recover-watcher.sh:/usr/local/bin/emergency-recover-watcher.sh:ro

      # Plugin database backup script (runs every 5 min)
      - ./scripts/plugin-db-backup.sh:/usr/local/bin/plugin-db-backup.sh:ro

      # Graceful shutdown scripts
      - ./scripts/lightningd-wrapper.sh:/usr/local/bin/lightningd-wrapper.sh:ro
      - ./scripts/pre-stop.sh:/usr/local/bin/pre-stop.sh:ro

    ports:
      # Lightning P2P (only needed for clearnet/hybrid modes)
      - "${LIGHTNING_PORT:-9736}:${LIGHTNING_PORT:-9736}"

      # c-lightning-REST API (for RTL)
      - "3001:3001"

    networks:
      - lightning-network

    healthcheck:
      test: ["CMD", "lightning-cli", "--lightning-dir=/data/lightning/${NETWORK:-bitcoin}", "getinfo"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,node"
        tag: "{{.Name}}/{{.ID}}"

    labels:
      - "com.cl-hive.service=lightning"
      - "com.cl-hive.backup=true"

  # =========================================================================
  # Ride The Lightning - Web UI for Lightning Node Management
  # =========================================================================
  # Enable with: docker-compose --profile rtl up -d
  # Or set RTL_ENABLED=true in .env (automatically added to COMPOSE_PROFILES)
  rtl:
    image: shahanafarooqui/rtl:0.15.2
    container_name: rtl
    restart: unless-stopped
    profiles:
      - rtl
    depends_on:
      cln:
        condition: service_healthy

    environment:
      - PORT=3000
      - HOST=0.0.0.0
      - APP_PASSWORD=${RTL_PASSWORD:-changeme}
      - LN_IMPLEMENTATION=CLN
      - LN_SERVER_URL=https://cln:3001
      - CONFIG_PATH=/data/RTL
      # c-lightning-REST stores macaroon in CLN data dir
      - MACAROON_PATH=/data/cln/${NETWORK:-bitcoin}/c-lightning-REST/certs

    volumes:
      - rtl-data:/data/RTL
      # Mount CLN data for macaroon access
      - lightning-data:/data/cln:ro

    ports:
      - "${RTL_PORT:-3000}:3000"

    networks:
      - lightning-network

    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    labels:
      - "com.cl-hive.service=rtl"

volumes:
  lightning-data:
    driver: local
    labels:
      - "com.cl-hive.backup=critical"
  tor-data:
    driver: local
    labels:
      - "com.cl-hive.backup=critical"
  rtl-data:
    driver: local

networks:
  lightning-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
