# =============================================================================
# Fluent Bit Configuration for cl-hive
# =============================================================================
# This configuration collects logs from the cl-hive node and ships them to
# your preferred destination (Elasticsearch, Loki, file, etc.)
#
# Usage with Docker Compose:
#   Add a fluent-bit service or use as sidecar container.
#
# Installation:
#   docker run -d --name fluent-bit \
#     -v ./logging/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro \
#     -v ./logging/parsers.conf:/fluent-bit/etc/parsers.conf:ro \
#     -v /var/run/docker.sock:/var/run/docker.sock:ro \
#     fluent/fluent-bit:latest
# =============================================================================

[SERVICE]
    # Flush interval (seconds)
    Flush         5
    # Daemon mode (off for Docker)
    Daemon        Off
    # Log level: error, warning, info, debug, trace
    Log_Level     info
    # Parsers file
    Parsers_File  parsers.conf
    # HTTP monitoring endpoint
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# =============================================================================
# INPUTS
# =============================================================================

# Docker container logs
[INPUT]
    Name              tail
    Path              /var/log/supervisor/*.log
    Path_Key          log_file
    Tag               supervisor.*
    Parser            supervisor
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On

# Lightning daemon logs
[INPUT]
    Name              tail
    Path              /data/lightning/*/lightningd.log
    Path_Key          log_file
    Tag               lightningd
    Parser            lightningd
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Multiline         On
    Multiline_Flush   5

# Tor logs
[INPUT]
    Name              tail
    Path              /var/log/tor/*.log
    Path_Key          log_file
    Tag               tor
    Parser            tor
    Refresh_Interval  10
    Mem_Buf_Limit     10MB

# =============================================================================
# FILTERS
# =============================================================================

# Add common metadata
[FILTER]
    Name          record_modifier
    Match         *
    Record        hostname ${HOSTNAME}
    Record        service cl-hive
    Record        network ${NETWORK}

# Parse Lightning daemon structured fields
[FILTER]
    Name          parser
    Match         lightningd
    Key_Name      log
    Parser        lightningd_json
    Reserve_Data  On

# Extract plugin name from cl-hive logs
[FILTER]
    Name          grep
    Match         lightningd
    Regex         log .*cl-hive.*

# Add severity levels
[FILTER]
    Name          modify
    Match         *
    Condition     Key_Value_Equals level INFO
    Set           severity info

[FILTER]
    Name          modify
    Match         *
    Condition     Key_Value_Equals level WARNING
    Set           severity warning

[FILTER]
    Name          modify
    Match         *
    Condition     Key_Value_Equals level ERROR
    Set           severity error

# =============================================================================
# OUTPUTS
# =============================================================================

# Standard output (for debugging)
[OUTPUT]
    Name          stdout
    Match         *
    Format        json_lines

# File output (local archival)
[OUTPUT]
    Name          file
    Match         *
    Path          /var/log/fluent-bit/
    File          cl-hive.log
    Format        json_lines

# -----------------------------------------------------------------------------
# Optional: Elasticsearch output
# Uncomment and configure for ELK stack
# -----------------------------------------------------------------------------
#[OUTPUT]
#    Name          es
#    Match         *
#    Host          ${ELASTICSEARCH_HOST}
#    Port          ${ELASTICSEARCH_PORT}
#    Index         cl-hive
#    Type          _doc
#    HTTP_User     ${ELASTICSEARCH_USER}
#    HTTP_Passwd   ${ELASTICSEARCH_PASSWORD}
#    tls           On
#    tls.verify    On
#    Suppress_Type_Name On
#    # Retry on failure
#    Retry_Limit   5

# -----------------------------------------------------------------------------
# Optional: Grafana Loki output
# Uncomment and configure for Loki/Grafana
# -----------------------------------------------------------------------------
#[OUTPUT]
#    Name          loki
#    Match         *
#    Host          ${LOKI_HOST}
#    Port          ${LOKI_PORT}
#    Labels        job=cl-hive, service=$service, network=$network
#    # Authentication
#    HTTP_User     ${LOKI_USER}
#    HTTP_Passwd   ${LOKI_PASSWORD}
#    # Tenant ID for multi-tenant setups
#    Tenant_ID     ${LOKI_TENANT_ID}

# -----------------------------------------------------------------------------
# Optional: Forward to another Fluent Bit/Fluentd
# Uncomment for centralized logging infrastructure
# -----------------------------------------------------------------------------
#[OUTPUT]
#    Name          forward
#    Match         *
#    Host          ${FLUENTD_HOST}
#    Port          24224
#    # TLS settings
#    tls           On
#    tls.verify    On

# =============================================================================
# HEALTH CHECK
# =============================================================================
# Access metrics at http://localhost:2020/api/v1/metrics
# Access health at http://localhost:2020/api/v1/health
